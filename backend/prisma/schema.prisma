generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  username  String   @unique
  password  String
  fullName  String?
  bio       String?  @db.Text
  avatarUrl String?
  coverUrl  String?  
  department String? // Bölüm bilgisi
  class      String? // Sınıf bilgisi
  isVerified Boolean  @default(false)
  isPrivate  Boolean  @default(false)
  isBanned   Boolean  @default(false)
  role       UserRole @default(USER)
  verificationCode String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  posts                Post[]
  likes                Like[]
  comments             Comment[]
  following            Follow[]       @relation("UserFollowing")
  followers            Follow[]       @relation("UserFollowers")
  notifications        Notification[] @relation("NotificationRecipient")
  triggeredNotifications Notification[] @relation("NotificationSender")
  blockedUsers         Block[]        @relation("Blocker")
  blockedBy            Block[]        @relation("Blocked")
  badges               UserBadge[]
  sentRequests         FollowRequest[] @relation("SentRequests")
  receivedRequests     FollowRequest[] @relation("ReceivedRequests")
  foundedClubs         Club[]          @relation("ClubFounder")
  advisorClubs         Club[]          @relation("ClubAdvisor")
  clubMemberships      ClubMember[]
  
  feedbacks            Feedback[]
  reportsSent          Report[]        @relation("ReportedBy")
  reportsAgainst       Report[]        @relation("ReportedUser")
  
  conversations        ConversationParticipant[]
  messagesSent         Message[] @relation("SentMessages")
  spotListings         SpotListing[]
}

model Conversation {
  id          Int      @id @default(autoincrement())
  isAccepted  Boolean  @default(true)
  isRejected  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  participants ConversationParticipant[]
  messages     Message[]
}

model ConversationParticipant {
  id             Int      @id @default(autoincrement())
  conversationId Int
  userId         Int
  themeColor     String   @default("#4f46e5")
  joinedAt       DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
}

model Message {
  id             Int      @id @default(autoincrement())
  conversationId Int
  senderId       Int
  content        String   @db.Text
  isRead         Boolean  @default(false)
  createdAt      DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([senderId])
}

enum BadgeType {
  USER
  CLUB
}

model Badge {
  id          Int         @id @default(autoincrement())
  name        String      @unique
  icon        String?     
  color       String      @default("#1E3A8A")
  description String?
  type        BadgeType   @default(USER)
  createdAt   DateTime    @default(now())

  users       UserBadge[]
  clubs       ClubBadge[]
}

model UserBadge {
  id        Int      @id @default(autoincrement())
  userId    Int
  badgeId   Int
  assignedAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge     Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
}

model ClubBadge {
  id        Int      @id @default(autoincrement())
  clubId    Int
  badgeId   Int
  assignedAt DateTime @default(now())

  club      Club     @relation(fields: [clubId], references: [id], onDelete: Cascade)
  badge     Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([clubId, badgeId])
}

model FollowRequest {
  id          Int      @id @default(autoincrement())
  senderId    Int
  receiverId  Int
  status      RequestStatus @default(PENDING)
  createdAt   DateTime @default(now())

  sender      User @relation("SentRequests", fields: [senderId], references: [id], onDelete: Cascade)
  receiver    User @relation("ReceivedRequests", fields: [receiverId], references: [id], onDelete: Cascade)

  @@unique([senderId, receiverId])
  @@index([receiverId])
}

enum RequestStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum UserRole {
  USER
  ADMIN
  ACADEMIC
}

model Category {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  slug        String   @unique
  description String?
  color       String   @default("#6B7280")
  icon        String?
  createdAt   DateTime @default(now())

  posts Post[]
}

model Post {
  id         Int      @id @default(autoincrement())
  content    String?  @db.Text
  imageUrl   String?  
  published  Boolean  @default(true)
  authorId   Int
  categoryId Int?
  repostId   Int?     
  sentiment      String?  
  sentimentScore Float?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  author        User           @relation(fields: [authorId], references: [id], onDelete: Cascade)
  category      Category?      @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  repostOf      Post?          @relation("Reposts", fields: [repostId], references: [id], onDelete: Cascade)
  reposts       Post[]         @relation("Reposts")
  likes         Like[]
  comments      Comment[]
  notifications Notification[]
  reports       Report[]

  @@index([authorId])
  @@index([categoryId])
  @@index([createdAt])
  @@index([repostId])
}

model Like {
  id        Int      @id @default(autoincrement())
  userId    Int
  postId    Int
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([postId])
  @@index([userId])
}

model Comment {
  id        Int      @id @default(autoincrement())
  content   String   @db.Text
  userId    Int
  postId    Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([userId])
}

model Follow {
  id          Int      @id @default(autoincrement())
  followerId  Int
  followingId Int
  createdAt   DateTime @default(now())

  follower  User @relation("UserFollowing", fields: [followerId], references: [id], onDelete: Cascade)
  following User @relation("UserFollowers", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

model Notification {
  id         Int              @id @default(autoincrement())
  type       NotificationType
  recipientId Int
  senderId   Int?
  postId     Int?
  read       Boolean          @default(false)
  createdAt  DateTime         @default(now())

  recipient User  @relation("NotificationRecipient", fields: [recipientId], references: [id], onDelete: Cascade)
  sender    User? @relation("NotificationSender", fields: [senderId], references: [id], onDelete: Cascade)
  post      Post? @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([recipientId])
  @@index([read])
  @@index([createdAt])
}

model Block {
  id          Int      @id @default(autoincrement())
  blockerId   Int      
  blockedId   Int      
  createdAt   DateTime @default(now())

  blocker     User     @relation("Blocker", fields: [blockerId], references: [id], onDelete: Cascade)
  blocked     User     @relation("Blocked", fields: [blockedId], references: [id], onDelete: Cascade)

  @@unique([blockerId, blockedId])
  @@index([blockerId])
  @@index([blockedId])
}

model Feedback {
  id        Int      @id @default(autoincrement())
  type      String   
  message   String   @db.Text
  userId    Int?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  createdAt DateTime @default(now())
}

model Report {
  id               Int      @id @default(autoincrement())
  reporterId       Int
  reporter         User     @relation("ReportedBy", fields: [reporterId], references: [id])
  reportedUserId   Int?
  reportedUser     User?    @relation("ReportedUser", fields: [reportedUserId], references: [id])
  reportedPostId   Int?
  reportedPost     Post?    @relation(fields: [reportedPostId], references: [id])
  reason           String
  subReason        String?
  status           String   @default("PENDING") 
  createdAt        DateTime @default(now())
}

model Club {
  id               Int      @id @default(autoincrement())
  name             String   @unique
  slug             String   @unique
  description      String   @db.Text
  category         String   
  emoji            String?  
  color            String   @default("#e11d48")
  logoUrl          String?  
  memberCount      Int      @default(0)
  status           ClubStatus @default(PENDING)
  founderId        Int?
  advisorName      String?
  advisorEmail     String?
  academicApproval Boolean  @default(false)
  adminApproval    Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  founder          User?    @relation("ClubFounder", fields: [founderId], references: [id])
  advisor          User?    @relation("ClubAdvisor", fields: [advisorEmail], references: [email])
  members          ClubMember[]
  badges           ClubBadge[]
}

model ClubMember {
  id        Int      @id @default(autoincrement())
  clubId    Int
  userId    Int
  role      String   @default("MEMBER") 
  joinedAt  DateTime @default(now())

  club      Club     @relation(fields: [clubId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([clubId, userId])
}

enum ClubStatus {
  PENDING
  APPROVED
  REJECTED
}

enum NotificationType {
  LIKE    
  COMMENT 
  FOLLOW  
  MENTION
}

model SpotListing {
  id          Int          @id @default(autoincrement())
  title       String       
  description String       @db.Text
  price       Float?       
  imageUrl    String?      
  category    SpotCategory @default(AL_SAT)
  status      ListingStatus @default(ACTIVE) 
  location    String?      // Örn: İstiklal Yerleşkesi, KYK Yurdu vb.
  contactInfo String?      // WhatsApp veya iletişim tercihi
  isNegotiable Boolean     @default(false) // Pazarlık payı var mı?
  authorId    Int
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  author      User         @relation(fields: [authorId], references: [id], onDelete: Cascade)
}

enum SpotCategory {
  AL_SAT        // İkinci El / Al-Sat
  EV_ARKADASI   // Ev arkadaşı / Konaklama
  KAMPUS_RADARI // İndirimler / Yemek Fırsatları
  YOL_ARKADASI  // Araç paylaşımı / Yolculuk
  ODUNC         // Ödünç Al-Ver
  YETENEK       // Freelance işler / Yetenekler
  STAJ_IS       // Staj ve İş Fırsatları
}

enum ListingStatus {
  ACTIVE        // Yayında
  SOLD          // Satıldı / Bulundu
  CLOSED        // Kapandı
}
