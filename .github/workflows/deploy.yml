name: üöÄ MAKUtalk Auto Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: üöö Checkout Code
        uses: actions/checkout@v3

      - name: üöÄ Deploy to DigitalOcean
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            mkdir -p ~/MAKUtalk
            cd ~/MAKUtalk

            if [ ! -d ".git" ]; then
              git clone https://github.com/${{ github.repository }}.git .
            else
              git fetch origin main
              git reset --hard origin/main
            fi

            # YAML yapƒ±sƒ±nƒ± bozmadan, .env dosyasƒ±nƒ± g√ºvenle olu≈üturuyoruz.
            # Deƒüi≈ükenleri tek tek 'echo' ile basarak bo≈üluk riskini sƒ±fƒ±rlƒ±yoruz.
            echo "DB_USERNAME=admin" > .env
            echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
            echo "DB_NAME=makutalk_db" >> .env
            echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> .env
            echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
            echo "RESEND_API_KEY=${{ secrets.RESEND_API_KEY }}" >> .env
            echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" >> .env
            echo "SMTP_FROM=${{ secrets.SMTP_FROM }}" >> .env
            echo "VITE_API_URL=${{ secrets.VITE_API_URL }}" >> .env
            echo "FRONTEND_URL=${{ secrets.FRONTEND_URL }}" >> .env
            
            # Backend klas√∂r√ºne de kopyala
            cp .env backend/.env

            sudo docker-compose down
            sudo docker-compose up -d --build
            sudo docker image prune -f
