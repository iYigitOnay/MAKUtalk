name: ğŸš€ MAKUtalk Auto Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸšš Checkout Code
        uses: actions/checkout@v3

      - name: ğŸš€ Deploy to DigitalOcean
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Proje klasÃ¶rÃ¼ne gir veya oluÅŸtur
            mkdir -p ~/MAKUtalk
            cd ~/MAKUtalk

            # Repoyu gÃ¼ncelle
            if [ ! -d ".git" ]; then
              git clone https://github.com/${{ github.repository }}.git .
            else
              git fetch origin main
              git reset --hard origin/main
            fi

            # .env dosyasÄ±nÄ± oluÅŸtururken shell interpolation riskini 'cat' ile sÄ±fÄ±rlÄ±yoruz.
            # Tek bir bÃ¼yÃ¼k blok halinde, YAML boÅŸluk kurallarÄ±na uygun.
            printf "DB_USERNAME=admin\nDB_PASSWORD=${{ secrets.DB_PASSWORD }}\nDB_NAME=makutalk_db\nDATABASE_URL=${{ secrets.DATABASE_URL }}\nJWT_SECRET=${{ secrets.JWT_SECRET }}\nRESEND_API_KEY=${{ secrets.RESEND_API_KEY }}\nGEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}\nSMTP_FROM=${{ secrets.SMTP_FROM }}\nVITE_API_URL=${{ secrets.VITE_API_URL }}\nFRONTEND_URL=${{ secrets.FRONTEND_URL }}" > .env

            # Docker'Ä± tamamen sÄ±fÄ±rla ve her ÅŸeyi taze build et
            sudo docker-compose down --remove-orphans
            sudo docker-compose up -d --build
            sudo docker image prune -f
