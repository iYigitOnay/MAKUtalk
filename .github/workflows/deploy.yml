name: ðŸš€ MAKUtalk Auto Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸšš Checkout Code
        uses: actions/checkout@v3

      - name: ðŸš€ Deploy to DigitalOcean
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            mkdir -p ~/MAKUtalk
            cd ~/MAKUtalk

            if [ ! -d ".git" ]; then
              git clone https://github.com/${{ github.repository }}.git .
            else
              git fetch origin main
              git reset --hard origin/main
            fi

            # GitHub Secret'larÄ± .env dosyasÄ±na senin formatÄ±nda dÃ¶kÃ¼yoruz
            cat <<EOF > .env
            DB_USERNAME=admin
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            DB_NAME=makutalk_db
            DATABASE_URL="postgresql://admin:${{ secrets.DB_PASSWORD }}@db:5432/makutalk_db?schema=public"
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            RESEND_API_KEY=${{ secrets.RESEND_API_KEY }}
            GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
            SMTP_FROM="${{ secrets.SMTP_FROM }}"
            VITE_API_URL=${{ secrets.VITE_API_URL }}
            FRONTEND_URL=${{ secrets.FRONTEND_URL }}
            EOF

            sudo docker-compose down
            sudo docker-compose up -d --build
            sudo docker image prune -f
